on:
  push:
  workflow_dispatch:
    inputs:
      save:
        description: 'Save Wheels'
        required: true
        default: false
        type: boolean

name: Multi-platform Compatibility Test (Tox)
jobs:
  build:
    runs-on: ${{ matrix.os }}
    env:
      PIP_EXTRA_INDEX_URL: ${{vars.PIP_EXTRA_INDEX_URL}}
      UV_EXTRA_INDEX_URL: ${{vars.PIP_EXTRA_INDEX_URL}}
      UV_CONSTRAINT: requirements-dev.txt
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
        include:
          - os: macos-latest
            compiler_libcxx: libc++
          - os: ubuntu-latest
            compiler_libcxx: libstdc++11
          - os: windows-latest
      fail-fast: false
    name: Python ${{ matrix.python-version }} ${{ matrix.os }} build

    steps:
      - uses: actions/github-script@v6
        id: conan-path-script
        with:
          result-encoding: string
          script: |
            if ('${{matrix.os}}' === 'windows-latest'){
              return 'C:/Users/runneradmin'
            }
            if ('${{matrix.os}}' === 'ubuntu-latest'){
              return '/home/runner'
            }
            if ('${{matrix.os}}' === 'macos-latest'){
              return '/Users/runner'
            }
            return ''
      - uses: actions/github-script@v6
        id: tox-env
        with:
          script: |
            const frontend = "${{matrix.frontend}}"
            const toxEnv = "py${{matrix.python-version}}".replace('.','') 
            if(frontend === ""){
              return toxEnv
            }
            return "py${{matrix.python-version}}".replace('.','') + "-${{matrix.frontend}}"
          result-encoding: string
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip' # caching pip dependencies
          cache-dependency-path: |
            requirements-dev.txt
            requirements/requirements-*.txt
      - name: Install dependencies
        run: |
          pip install uv
      - name: Remove Strawberry Perl (Windows only)
        if: contains(matrix.os, 'windows')
        run: Remove-Item –path C:\\Strawberry –recurse –force
      - name: Cache Conan
        id: cache-conan
        uses: actions/cache@v3
        with:
          path: "${{steps.conan-path-script.outputs.result}}/.conan"
          key: ${{ runner.os }}-conan-${{ hashFiles('conanfile.py') }}

      - name: Prebuild Conan packages (Windows)
        if: |
          contains(matrix.os, 'windows') && steps.cache-conan.outputs.cache-hit != 'true'
        shell: cmd
        env:
          CONAN_USER_HOME: "${{steps.conan-path-script.outputs.result}}"
        run: |
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=amd64 && uvx --index-strategy unsafe-best-match --with cmake conan profile detect --exist-ok
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=amd64 && uvx --index-strategy unsafe-best-match --with cmake conan install conanfile.py --build missing -of %TEMP%\ciwheelbuilder -pr:b=default

      - name: Prebuild Conan packages
        env:
          CONAN_USER_HOME: "${{steps.conan-path-script.outputs.result}}"
        if: "!contains(matrix.os, 'windows') && steps.cache-conan.outputs.cache-hit != 'true'"
        run: |
          uvx --index-strategy unsafe-best-match --with cmake conan profile detect --exist-ok
          uvx --index-strategy unsafe-best-match --with cmake conan install conanfile.py --build missing -of /tmp/ciwheelbuilder -pr:b=default
          

      - name: Run Tox (Windows)
        if: contains(matrix.os, 'windows')
        shell: cmd
        run: |
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=amd64 && uvx --with tox-uv tox run
        env:
          TOX_ENV: "${{ steps.tox-env.outputs.result }}"
          CONAN_USER_HOME: "${{steps.conan-path-script.outputs.result}}"
      - name: Run Tox
        if: "!contains(matrix.os, 'windows')"
        run: cc --version &&  cc -dumpfullversion -dumpversion && uvx --with tox-uv tox run -vvv
        env:
          TOX_ENV: "${{ steps.tox-env.outputs.result }}"
          CONAN_USER_HOME: "${{steps.conan-path-script.outputs.result}}"
          CONAN_COMPILER_LIBCXX: ${{ matrix.compiler_libcxx }}

        #   CIBW_SOME_OPTION: value
      - uses: actions/upload-artifact@v4
        if:  ${{ inputs.save }}
        with:
          name: uiucprescon.ocr-wheels
          path: ./wheelhouse/*.whl

